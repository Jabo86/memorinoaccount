<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MemorinoAccount</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <!-- CDN CryptoJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-hover: #1565c0;
      --danger-color: #e53935;
      --bg-light: #f9f9f9;
      --text-light: #333;
      --card-light: #fff;
      --shadow-light: rgba(0, 0, 0, 0.08);
      --bg-dark: #121212;
      --text-dark: #eee;
      --card-dark: #1e1e1e;
      --shadow-dark: rgba(255, 255, 255, 0.08);
      --error-color: #d32f2f;
      --success-color: #2e7d32;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: var(--bg-light);
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem 3rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 2rem;
      user-select: none;
    }

    h1 {
      font-size: 2.5rem;
      color: var(--primary-color);
    }
    body.dark h1 {
      color: var(--primary-hover);
    }

    #themeToggle {
      cursor: pointer;
      font-size: 1.8rem;
      user-select: none;
      transition: color 0.3s ease;
      color: var(--primary-color);
    }
    body.dark #themeToggle {
      color: var(--primary-hover);
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .container {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .card {
      background-color: var(--card-light);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 6px 20px var(--shadow-light);
      border: 1px solid #e0e0e0;
      transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
    body.dark .card {
      background-color: var(--card-dark);
      box-shadow: 0 6px 20px var(--shadow-dark);
      border-color: #333;
    }

    input, button {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.8rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }
    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 6px var(--primary-color);
    }
    body.dark input {
      background: #2a2a2a;
      border-color: #555;
      color: var(--text-dark);
    }
    body.dark input:focus {
      border-color: var(--primary-hover);
      box-shadow: 0 0 6px var(--primary-hover);
    }

    button {
      background-color: var(--primary-color);
      color: #fff;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover {
      background-color: var(--primary-hover);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .logout {
      background-color: var(--danger-color);
      margin-top: 1rem;
    }
    .logout:hover {
      background-color: #b71c1c;
    }

    .error-message {
      color: var(--error-color);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      text-align: center;
    }
    body.dark .error-message {
      color: #ef5350;
    }

    .success-message {
      color: var(--success-color);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      text-align: center;
    }
    body.dark .success-message {
      color: #81c784;
    }

    .welcome-message {
      font-weight: 600;
      color: var(--success-color);
      text-align: center;
      margin-bottom: 1rem;
      user-select: none;
    }
    body.dark .welcome-message {
      color: #81c784;
    }

    .account-item {
      background: var(--card-light);
      border-radius: 12px;
      box-shadow: 0 3px 10px var(--shadow-light);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    body.dark .account-item {
      background: var(--card-dark);
      box-shadow: 0 3px 10px var(--shadow-dark);
    }

    .account-name {
      font-weight: 600;
      flex: 0 0 25%;
      min-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 1.1rem;
      color: var(--primary-color);
      user-select: text;
    }
    body.dark .account-name {
      color: var(--primary-hover);
    }

    .account-email {
      flex: 0 0 25%;
      min-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
      user-select: text;
    }

    .password-wrapper {
      flex: 1;
      position: relative;
    }

    .password-wrapper input {
      width: 100%;
      padding: 0.6rem 2.8rem 0.6rem 1rem;
      font-family: monospace;
      font-size: 1rem;
      border: 1.5px solid #bbb;
      border-radius: 12px;
      background: transparent;
      color: inherit;
      user-select: text;
    }
    .password-wrapper input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 6px var(--primary-color);
    }
    body.dark .password-wrapper input {
      border-color: #555;
    }
    body.dark .password-wrapper input:focus {
      border-color: var(--primary-hover);
      box-shadow: 0 0 6px var(--primary-hover);
    }

    .toggle-password {
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 1.3rem;
      color: var(--primary-color);
      user-select: none;
      transition: color 0.3s ease;
    }
    .toggle-password:hover {
      color: var(--primary-hover);
    }
    body.dark .toggle-password {
      color: var(--primary-hover);
    }

    .btn-delete {
      flex: 0 0 auto;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      color: var(--danger-color);
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }
    .btn-delete:hover {
      background-color: rgba(229, 57, 53, 0.15);
    }
    .btn-delete svg {
      width: 18px;
      height: 18px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    #importFile:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }
      h1 {
        font-size: 2rem;
      }
      .card {
        padding: 1.2rem;
      }
      .account-name, .account-email {
        font-size: 0.9rem;
        min-width: 100px;
      }
      .password-wrapper input {
        font-size: 0.9rem;
      }
      .toggle-password {
        font-size: 1.1rem;
      }
      .btn-delete {
        width: 28px;
        height: 28px;
      }
      .btn-delete svg {
        width: 16px;
        height: 16px;
      }
    }

    @media (max-width: 500px) {
      .account-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .account-name, .account-email {
        flex: 1 1 100%;
        width: 100%;
      }
      .password-wrapper {
        flex: 1 1 100%;
        width: 100%;
      }
      .btn-delete {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Memorino Account</h1>
    <div id="themeToggle" title="Cambia tema" aria-label="Cambia tema">
      <span class="visually-hidden">Cambia tema</span>
      <span class="theme-icon">🌞</span>
    </div>
  </header>

  <div class="container">
    <div class="card" id="loginContainer">
      <input type="text" id="username" placeholder="Nome utente" autocomplete="username" />
      <input type="password" id="userpass" placeholder="Password" autocomplete="current-password" />
      <div class="error-message" id="errorMessage"></div>
      <button id="loginBtn">Accedi</button>
    </div>

    <div class="card" id="mainApp" style="display:none;">
      <div class="welcome-message" id="welcomeMessage"></div>
      <input type="text" id="accountName" placeholder="Nome Account" autocomplete="off" />
      <input type="email" id="accountEmail" placeholder="Email" autocomplete="email" />
      <input type="password" id="accountPassword" placeholder="Password" autocomplete="new-password" />
      <div class="error-message" id="accountErrorMessage"></div>
      <div class="success-message" id="accountSuccessMessage"></div>
      <button id="saveAccountBtn" disabled>Salva Account</button>
      <button id="buyProBtn" style="display:none;">Passa a Pro</button>
      <button onclick="exportData()">Esporta Dati</button>
      <input type="file" id="importFile" accept="application/json" onchange="importData(event)" style="margin-top: 1rem;" />
      <button class="logout" id="logoutBtn">Logout</button>
    </div>

    <div id="accountList" style="display:none;"></div>
  </div>

  <script>
    // Importazione del plugin Capacitor per gli acquisti in-app
    // Nota: Per usare questa importazione, il codice deve essere in un file .js separato o configurato con un bundler (es. Vite, Webpack)
    // Per semplicità, assumiamo che Capacitor sia incluso tramite script nel file capacitor.config.json
    // Se usi un bundler, aggiungi: import { InAppPurchases } from '@capacitor-community/in-app-purchases';

    // Verifica che CryptoJS sia caricato
    if (typeof CryptoJS === 'undefined') {
      console.error("Errore: CryptoJS non è caricato.");
      alert("Errore: la libreria di crittografia non è disponibile. Controlla la connessione o il CDN.");
      window.CryptoJS = {
        AES: {
          encrypt: function(text, key) {
            console.warn("CryptoJS non disponibile - usando fallback non sicuro");
            return text;
          },
          decrypt: function(cipher, key) {
            console.warn("CryptoJS non disponibile - usando fallback non sicuro");
            return cipher;
          }
        },
        SHA256: function(text) {
          console.warn("CryptoJS non disponibile - usando fallback non sicuro");
          return { toString: function() { return text; } };
        },
        enc: { Utf8: {} }
      };
    }

    // Funzioni di crittografia con gestione errori migliorata
    const encrypt = (text, key) => {
      try {
        if (!text || typeof text !== 'string') throw new Error("Testo non valido");
        if (!key || typeof key !== 'string') throw new Error("Chiave non valida");
        return CryptoJS.AES.encrypt(text, key).toString();
      } catch (e) {
        console.error("Errore di crittografia:", e);
        showAccountError("Errore durante la crittografia");
        return null;
      }
    };

    const decrypt = (cipher, key) => {
      try {
        if (!cipher || !key) throw new Error("Input non validi");
        const bytes = CryptoJS.AES.decrypt(cipher, key);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        if (!decrypted) throw new Error("Decrittazione fallita");
        return decrypted;
      } catch (e) {
        console.error("Errore di decrittazione:", e);
        return "";
      }
    };

    // Funzioni tema
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    function setTheme(dark) {
      if (dark) {
        body.classList.add('dark');
        document.querySelector('.theme-icon').textContent = '🌙';
        localStorage.setItem('theme', 'dark');
      } else {
        body.classList.remove('dark');
        document.querySelector('.theme-icon').textContent = '🌞';
        localStorage.setItem('theme', 'light');
      }
    }
    themeToggle.onclick = () => setTheme(!body.classList.contains('dark'));
    setTheme(localStorage.getItem('theme') === 'dark');

    // Elementi UI
    const loginContainer = document.getElementById('loginContainer');
    const mainApp = document.getElementById('mainApp');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const usernameInput = document.getElementById('username');
    const userpassInput = document.getElementById('userpass');
    const accountNameInput = document.getElementById('accountName');
    const accountEmailInput = document.getElementById('accountEmail');
    const accountPasswordInput = document.getElementById('accountPassword');
    const saveAccountBtn = document.getElementById('saveAccountBtn');
    const buyProBtn = document.getElementById('buyProBtn');
    const accountList = document.getElementById('accountList');
    const errorMessage = document.getElementById('errorMessage');
    const accountErrorMessage = document.getElementById('accountErrorMessage');
    const accountSuccessMessage = document.getElementById('accountSuccessMessage');

    let currentUser = null;
    let currentKey = null;

    // Funzioni di salvataggio e caricamento
    function saveUsers(users) {
      try {
        localStorage.setItem('users', JSON.stringify(users));
        return true;
      } catch (e) {
        console.error("Errore nel salvataggio:", e);
        showAccountError("Errore nel salvataggio. Spazio esaurito?");
        return false;
      }
    }

    function getUsers() {
      try {
        const data = localStorage.getItem('users');
        return data ? JSON.parse(data) : {};
      } catch (e) {
        console.error("Errore nel caricamento:", e);
        return {};
      }
    }

    // Funzione di hash con fallback
    function hashPassword(password) {
      try {
        if (!password) throw new Error("Password vuota");
        return CryptoJS.SHA256(password).toString();
      } catch (e) {
        console.error("Errore hash:", e);
        return password; // Fallback non sicuro
      }
    }

    // Gestione messaggi
    function showError(msg) {
      errorMessage.textContent = msg;
      setTimeout(() => errorMessage.textContent = '', 5000);
    }

    function showAccountError(msg) {
      accountErrorMessage.textContent = msg;
      accountSuccessMessage.textContent = '';
      setTimeout(() => accountErrorMessage.textContent = '', 5000);
    }

    function showAccountSuccess(msg) {
      accountSuccessMessage.textContent = msg;
      accountErrorMessage.textContent = '';
      setTimeout(() => accountSuccessMessage.textContent = '', 5000);
    }

    // Configurazione acquisti in-app
    async function setupInAppPurchases() {
      try {
        // Nota: Assicurati che il plugin InAppPurchases sia disponibile globalmente
        if (typeof InAppPurchases === 'undefined') {
          console.error("Plugin InAppPurchases non disponibile");
          showAccountError("Funzionalità Pro non disponibile");
          return;
        }
        await InAppPurchases.registerProduct({ id: 'pro_version', type: 'non_consumable' });
        await InAppPurchases.when('pro_version').approved(async (transaction) => {
          localStorage.setItem('isPro', 'true');
          await InAppPurchases.finishTransaction({ transactionId: transaction.transactionId });
          showAccountSuccess("Versione Pro sbloccata!");
          updateProButtonVisibility();
          loadAccounts();
        });
        await InAppPurchases.when('pro_version').error((err) => {
          showAccountError("Errore nell'acquisto: " + err.message);
        });
      } catch (e) {
        console.error("Errore nella configurazione degli acquisti in-app:", e);
        showAccountError("Errore nella configurazione degli acquisti");
      }
    }

    // Verifica stato Pro
    async function checkProStatus() {
      const isPro = localStorage.getItem('isPro') === 'true';
      if (!isPro && typeof InAppPurchases !== 'undefined') {
        try {
          const purchases = await InAppPurchases.restorePurchases();
          if (purchases.some(p => p.productId === 'pro_version' && p.state === 'purchased')) {
            localStorage.setItem('isPro', 'true');
            showAccountSuccess("Versione Pro ripristinata!");
          }
        } catch (e) {
          console.error("Errore nel ripristino acquisti:", e);
        }
      }
      updateProButtonVisibility();
    }

    // Aggiorna visibilità del pulsante Pro
    function updateProButtonVisibility() {
      const isPro = localStorage.getItem('isPro') === 'true';
      buyProBtn.style.display = isPro ? 'none' : 'block';
    }

    // Acquisto versione Pro
    buyProBtn.onclick = async () => {
      try {
        if (typeof InAppPurchases === 'undefined') {
          showAccountError("Acquisti in-app non disponibili");
          return;
        }
        await InAppPurchases.purchaseProduct({ productId: 'pro_version' });
      } catch (e) {
        showAccountError("Errore nell'avvio dell'acquisto: " + e.message);
      }
    };

    // Login
    loginBtn.onclick = () => {
      const user = usernameInput.value.trim();
      const pass = userpassInput.value;

      if (!user || !pass) {
        showError("Inserisci nome utente e password");
        return;
      }

      const users = getUsers();
      const userHash = hashPassword(pass);

      if (!users[user]) {
        users[user] = { passHash: userHash, accounts: [] };
      } else if (users[user].passHash !== userHash) {
        showError("Password errata");
        return;
      }

      currentUser = user;
      currentKey = pass;
      localStorage.setItem('authUser', user);
      initApp();
    };

    // Logout
    logoutBtn.onclick = () => {
      localStorage.removeItem('authUser');
      currentUser = currentKey = null;
      accountList.innerHTML = '';
      accountList.style.display = 'none';
      mainApp.style.display = 'none';
      loginContainer.style.display = 'block';
      [accountNameInput, accountEmailInput, accountPasswordInput].forEach(i => i.value = '');
      saveAccountBtn.disabled = true;
      [errorMessage, accountErrorMessage, accountSuccessMessage].forEach(e => e.textContent = '');
      updateProButtonVisibility();
    };

    // Inizializzazione app
    async function initApp() {
      loginContainer.style.display = 'none';
      mainApp.style.display = 'block';
      welcomeMessage.textContent = `Benvenuto, ${currentUser}!`;
      await checkProStatus();
      loadAccounts();
    }

    // Validazione input account
    function validateAccountInputs() {
      const nameValid = accountNameInput.value.trim();
      const emailValid = accountEmailInput.value.trim();
      const passValid = accountPasswordInput.value.trim();
      saveAccountBtn.disabled = !(nameValid && emailValid && passValid);
    }

    accountNameInput.addEventListener('input', validateAccountInputs);
    accountEmailInput.addEventListener('input', validateAccountInputs);
    accountPasswordInput.addEventListener('input', validateAccountInputs);

    // Salva account
    saveAccountBtn.onclick = () => {
      if (!currentUser || !currentKey) {
        showAccountError("Effettua il login");
        return;
      }

      const name = accountNameInput.value.trim();
      const email = accountEmailInput.value.trim();
      const pass = accountPasswordInput.value;

      if (!name || !email || !pass) {
        showAccountError("Compila tutti i campi");
        return;
      }

      if (!email.includes('@') || !email.includes('.')) {
        showAccountError("Inserisci un'email valida");
        return;
      }

      const users = getUsers();
      const accounts = users[currentUser]?.accounts || [];
      const isPro = localStorage.getItem('isPro') === 'true';

      // Limite di 5 account per utenti non-Pro
      if (!isPro && accounts.length >= 5 && users[currentUser].accounts.findIndex(a => a.name === name) === -1) {
        showAccountError("Limite di 5 account raggiunto. Passa alla versione Pro!");
        updateProButtonVisibility();
        return;
      }

      if (!users[currentUser]) {
        users[currentUser] = { passHash: hashPassword(currentKey), accounts: [] };
      }

      const existingIndex = users[currentUser].accounts.findIndex(a => a.name === name);
      const encryptedPass = encrypt(pass, currentKey);
      const encryptedEmail = encrypt(email, currentKey);

      if (encryptedPass === null || encryptedEmail === null) return;

      saveAccountBtn.textContent = 'Salvataggio...';
      saveAccountBtn.disabled = true;

      if (existingIndex >= 0) {
        users[currentUser].accounts[existingIndex].pass = encryptedPass;
        users[currentUser].accounts[existingIndex].email = encryptedEmail;
      } else {
        users[currentUser].accounts.push({
          name,
          email: encryptedEmail,
          pass: encryptedPass
        });
      }

      if (saveUsers(users)) {
        accountNameInput.value = '';
        accountEmailInput.value = '';
        accountPasswordInput.value = '';
        showAccountSuccess(existingIndex >= 0 ? "Account aggiornato!" : "Account salvato!");
        loadAccounts();
        updateProButtonVisibility();
      }

      saveAccountBtn.textContent = 'Salva Account';
      validateAccountInputs();
    };

    // Carica account
    function loadAccounts() {
      if (!currentUser || !currentKey) return;

      const users = getUsers();
      const accounts = users[currentUser]?.accounts || [];
      
      accountList.innerHTML = '';
      accountList.style.display = accounts.length ? 'block' : 'none';

      accounts.forEach((acc, index) => {
        const item = document.createElement('div');
        item.className = 'account-item';

        const nameEl = document.createElement('div');
        nameEl.className = 'account-name';
        nameEl.textContent = acc.name;

        const emailEl = document.createElement('div');
        emailEl.className = 'account-email';
        emailEl.textContent = decrypt(acc.email, currentKey);

        const passWrapper = document.createElement('div');
        passWrapper.className = 'password-wrapper';

        const passInput = document.createElement('input');
        passInput.type = 'password';
        passInput.readOnly = true;
        passInput.value = decrypt(acc.pass, currentKey);

        const toggleBtn = document.createElement('span');
        toggleBtn.className = 'toggle-password';
        toggleBtn.textContent = '👁️';
        toggleBtn.onclick = () => {
          passInput.type = passInput.type === 'password' ? 'text' : 'password';
          toggleBtn.textContent = passInput.type === 'password' ? '👁️' : '🙈';
        };

        passWrapper.append(passInput, toggleBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-delete';
        deleteBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        `;
        deleteBtn.onclick = () => {
          if (confirm(`Eliminare "${acc.name}"?`)) deleteAccount(index);
        };

        item.append(nameEl, emailEl, passWrapper, deleteBtn);
        accountList.appendChild(item);
      });
    }

    function deleteAccount(index) {
      const users = getUsers();
      if (users[currentUser]?.accounts) {
        users[currentUser].accounts.splice(index, 1);
        saveUsers(users);
        loadAccounts();
        updateProButtonVisibility();
      }
    }

    function exportData() {
      if (!currentUser) {
        showAccountError("Effettua il login");
        return;
      }

      try {
        const users = getUsers();
        const data = JSON.stringify(users[currentUser]);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `accounts_${currentUser}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
      } catch (e) {
        showAccountError("Errore nell'esportazione");
        console.error(e);
      }
    }

    function importData(event) {
      if (!currentUser) {
        showAccountError("Effettua il login");
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      const importInput = document.getElementById('importFile');
      importInput.disabled = true;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.accounts || !Array.isArray(data.accounts)) {
            throw new Error("Formato file non valido");
          }

          const users = getUsers();
          const isPro = localStorage.getItem('isPro') === 'true';

          // Limite di 5 account per utenti non-Pro
          if (!isPro && data.accounts.length > 5) {
            showAccountError("Impossibile importare più di 5 account nella versione gratuita. Passa a Pro!");
            importInput.disabled = false;
            event.target.value = '';
            return;
          }

          users[currentUser].accounts = data.accounts;
          
          if (saveUsers(users)) {
            showAccountSuccess(`Importati ${data.accounts.length} account`);
            loadAccounts();
            updateProButtonVisibility();
          }
        } catch (e) {
          showAccountError("Errore nell'importazione: " + e.message);
          console.error(e);
        } finally {
          importInput.disabled = false;
          event.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    // Inizializzazione
    window.addEventListener('DOMContentLoaded', async () => {
      const user = localStorage.getItem('authUser');
      if (user) {
        currentUser = user;
        usernameInput.value = user;
        userpassInput.focus();
      }
      // Configura gli acquisti in-app
      if (typeof InAppPurchases !== 'undefined') {
        await setupInAppPurchases();
        await checkProStatus();
      } else {
        console.warn("InAppPurchases non disponibile. Esegui l'app in un ambiente Capacitor.");
      }
    });
  </script>
</body>
</html>
